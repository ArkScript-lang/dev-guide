# Small number optimization - DRAFT

This is intended to provide a way to reduce the generated bytecode size (less entries in the constants table and smaller instructions) when using small numbers, ones between -128 (included) and 127 (included). It should also help a bit in term of performances, but that's not the main goal. Performances shouldn't be negatively impacted by this proposal.

## Definitions

_constants table_: a list of constants used throughout a program, stored alongside their type (number, string, function's address)

_small number_: a signed number on a single byte, in range `[-128 ; 127]`

## Precisions

The goal of this instruction is to ease common numbers usage in ArkScript (avoid a fat table (because we have a lot of common numbers in it), followed by a table lookup, and then the classic copy, push), thus we need a range like `[-128, 127]` to have negative numbers covered. This will be rather useful in case of array indexes, because we support negative numbers. Also this could relatively reduce the generated bytecode size for basic equations. Less bytes to read means less time lost, even though we won't get a 50% performance increase from this.

## Compiler's implementation

This needs to detect numbers used as integers (they are internally stored on `double`), in the given range. Instead of adding it to the constants table, we should generate a `LOAD_SMALL_NUM` instruction, alongside the value of the number.

## Virtual Machine implementation

Nothing will change on the constants table loading, we will only add a single instruction, reading a *single byte* (instead of the usual 2 bytes) and casting it into a signed integer, thus creating a new value and pushing it on the stack.

# Authors

* [Alexandre Plateau](https://github.com/SuperFola)